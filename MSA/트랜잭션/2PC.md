### 2PC(Two-Phase Commit) 프로토콜

#### 1. 개요
2PC(Two-Phase Commit) 프로토콜은 분산 시스템에서 트랜잭션의 원자성을 보장하기 위한 트랜잭션 관리 기법이다. 여러 개의 독립적인 시스템이 하나의 트랜잭션을 수행할 때, 전체 작업이 성공하거나 실패하도록 조정한다.

#### 2. 필요성
분산 시스템에서 여러 서비스가 하나의 트랜잭션처럼 동작해야 하는 경우가 발생한다. 예를 들어, 전자상거래 시스템에서 주문이 생성될 때 다음과 같은 작업이 동시에 수행되어야 한다.
- 재고 시스템에서 상품 재고 차감
- 결제 시스템에서 결제 처리

하나의 작업이 실패하면 다른 작업도 취소해야 한다. 그렇지 않으면 데이터 일관성이 깨질 수 있다. 이를 해결하기 위해 2PC 프로토콜이 사용된다.

#### 3. 동작 방식
2PC는 두 단계(Prepare 단계와 Commit 단계)로 구성된다.

##### 1) 준비 단계(Prepare Phase)
- Coordinator(조정자)는 참여자(Participant)에게 트랜잭션을 수행할 준비가 되었는지 요청한다.
- 각 참여자는 트랜잭션을 실행할 준비가 되면 "예(OK)"를 응답하고, 준비할 수 없으면 "아니요(Abort)"를 응답한다.

##### 2) 커밋 단계(Commit Phase)
- 모든 참여자가 "예(OK)"를 응답하면, Coordinator는 "Commit" 명령을 내려 트랜잭션을 확정한다.
- 하나라도 "아니요(Abort)"를 응답하면, Coordinator는 "Rollback" 명령을 내려 트랜잭션을 취소한다.

#### 4. 특징
- **일관성 보장**: 모든 참여자가 성공해야 커밋되므로 데이터 불일치가 발생하지 않는다.
- **분산 환경에서 유용**: 여러 데이터베이스 및 서비스 간 트랜잭션을 조정할 수 있다.
- **성능 저하 가능성**: 모든 참여자의 응답을 기다려야 하므로 지연이 발생할 수 있다.
- **Coordinator 장애 문제**: Coordinator가 고장 나면 트랜잭션이 중단될 수 있다.

#### 5. 2PC(XA) 프로토콜을 마이크로서비스 환경에서 사용하기 어려운 이유
2PC(XA) 프로토콜은 분산 트랜잭션의 원자성을 보장하지만, 마이크로서비스 환경에서는 다음과 같은 이유로 사용이 어렵다.
- **트랜잭션 경계 확장**: 마이크로서비스는 독립적인 배포와 확장을 목표로 하지만, 2PC는 여러 서비스가 하나의 트랜잭션을 공유하도록 강제하여 유연성을 제한한다.
- **성능 저하**: 네트워크 지연과 참여자 응답 대기 시간으로 인해 성능이 저하될 수 있다. 특히 고가용성을 요구하는 시스템에서는 속도 저하가 큰 문제가 된다.
- **Coordinator 장애 위험**: Coordinator가 단일 장애점(Single Point of Failure, SPOF)이 되어 전체 트랜잭션이 중단될 가능성이 높다.
- **비용 증가**: 2PC를 지원하는 분산 트랜잭션 관리자는 복잡성이 크고 운영 비용이 증가한다.

#### 6. 한계점 및 대안
2PC는 높은 신뢰성을 보장하지만, Coordinator 장애 시 트랜잭션이 교착 상태에 빠질 가능성이 있다. 따라서 마이크로서비스 아키텍처에서는 **Saga 패턴**과 같은 대체 기법이 많이 사용된다.

#### 7. 2PC(XA) 프로토콜과 마이크로서비스 환경에서의 한계
2PC(XA) 프로토콜은 데이터 일관성을 강력하게 보장하지만, 마이크로서비스 환경에서는 최종적 일관성(Eventual Consistency)을 선호하는 경우가 많다. 그 이유는 다음과 같다.
- **확장성 문제**: 2PC는 모든 참여자가 트랜잭션에 동기적으로 참여해야 하므로, 서비스가 증가할수록 확장성이 떨어진다.
- **가용성 저하**: Coordinator가 장애를 일으키면 전체 트랜잭션이 멈추고, 장애 복구 시간이 길어질 수 있다.
- **ACID와 최종적 일관성의 차이**: 2PC는 ACID 특성을 강력히 보장하지만, 마이크로서비스에서는 분산 환경에 적합한 최종적 일관성을 선호한다.

#### 8. 결론
2PC 프로토콜은 분산 트랜잭션을 원자적으로 수행하기 위한 대표적인 기법이다. 모든 참여자의 동의를 얻어 트랜잭션을 수행함으로써 데이터 일관성을 유지할 수 있다. 그러나 성능 저하와 Coordinator 장애 문제로 인해, 현대적인 분산 시스템에서는 대체 기법과 함께 고려해야 한다.